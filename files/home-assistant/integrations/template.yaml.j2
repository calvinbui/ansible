{%- raw %}
---

# https://www.home-assistant.io/integrations/template/


  # Persist last_changed
  # https://community.home-assistant.io/t/persistent-version-of-last-changed-for-the-ui/467163/67
-
  trigger:
    - platform: state
      entity_id:
        - device_tracker.calvin_s_z_fold7
        - device_tracker.tammy_s_s25_ultra
        - input_boolean.dishwasher_running
        - input_boolean.dryer_running
        - sensor.washing_machine_operation_state
      not_to:
        - unavailable
        - unknown
      not_from:
        - unavailable
        - unknown
  sensor:
    unique_id: dbf841e2-ae6f-4fc1-9534-a1046204945f
    name: Nominal Change History
    state: "OK"
    attributes:
      changes: >
        {% set current = this.attributes.get('changes', {}) %}
        {% set new = {trigger.entity_id: trigger.to_state.last_changed.isoformat()} %}
        {{ dict(current, **new) }}

-
  sensor:

  #
  # Solar and Electricity Consumption
  #
  -
    # How much electricity the house is consuming
    # solar1 + solar2 - huawei_meter_consumption
    name: "Home Power Consumption"
    unique_id: "home_power_consumption"
    icon: mdi:lightning-bolt
    unit_of_measurement: "W"
    device_class: power
    state_class: measurement
    state: >
      {% set meter_power = states('sensor.power_meter_active_power') | float(0) %}
      {% set inverter_1_power = states('sensor.inverter_1_active_power') | float(0) %}
      {% set inverter_2_power = states('sensor.inverter_2_active_power') | float(0) %}
      {% set battery_power = states('sensor.solplanet_al010k5sq2590170_power') | float(0) %}
      {{ (inverter_1_power + inverter_2_power - meter_power + battery_power)  | float(0) }}
  -
    # How much electricity being imported from the grid
    # The value is negative when drawing from the grid
    # and positive when drawing from solar. So we can assume
    # that any negative value is grid consumption. The value is
    # then inverted so it is more useful in other calculations
    name: "Grid Power Consumption"
    unique_id: "grid_power_consumption"
    icon: mdi:transmission-tower-export
    unit_of_measurement: "W"
    device_class: power
    state_class: measurement
    state: >
      {% set meter_power = states('sensor.power_meter_active_power') | float(0) %}
      {% if meter_power < 0 %}
        {{ (meter_power * -1) | float(0) }}
      {% else %}
        {{ 0.0 | float(0) }}
      {% endif %}
  -
    # How much solar is being fed back into the grid
    # Similar to above, any positive value is fed back. Any negative
    # value means nothing is being sent because there is no yield
    # or it is being consumed.
    name: "Grid Power Export"
    unique_id: "grid_power_export"
    icon: mdi:transmission-tower-import
    unit_of_measurement: "W"
    device_class: power
    state_class: measurement
    state: >
      {% set meter_power = states('sensor.power_meter_active_power') | float(0) %}
      {% if meter_power > 0 %}
        {{ meter_power | float(0) }}
      {% else %}
        {{ 0.0 | float(0) }}
      {% endif %}
  -
    # How much raw energy is being generated by both inverters. Add them together.
    name: "Total Solar Generation"
    unique_id: "total_solar_generation"
    icon: mdi:solar-power-variant
    unit_of_measurement: "W"
    device_class: power
    state_class: measurement
    state: >
      {% set inverter_1_power = states('sensor.inverter_1_active_power') | float(0) %}
      {% set inverter_2_power = states('sensor.inverter_2_active_power') | float(0) %}
      {{ (inverter_1_power + inverter_2_power) | float(0) }}
  -
    # How much solar is being self-consumed by the house
    #
    # Take the total raw solar yield and minus what we are feeding to the grid
    # When we are not feeding in anything, we are consuming it all, such as during sunrise/sunset.
    # The value of this sensor will be equal to the yield --> consume everything
    #
    # Once there is no more solar, the value of this sensor will be 0
    name: "Solar Self Consumption"
    unique_id: "solar_self_consumption"
    icon: mdi:lightning-bolt-circle
    unit_of_measurement: "W"
    device_class: power
    state_class: measurement
    state: >
      {% set yield = states('sensor.total_solar_generation') | float(0) %}
      {% set export = states('sensor.grid_power_export') | float(0) %}
      {% if yield > export %}
        {{ (yield - export) | float(0) }}
      {% else %}
        {{ 0.0 | float(0) }}
      {% endif %}
  -
    # How much solar is directly powering the home (excluding battery charging and discharging)
    # Home consumption - grid import - battery discharge = solar direct to home
    name: "Solar Direct Home Consumption"
    unique_id: "solar_direct_home_consumption"
    icon: mdi:home-lightning-bolt
    unit_of_measurement: "W"
    device_class: power
    state_class: measurement
    state: >
      {% set home_consumption = states('sensor.home_power_consumption') | float(0) %}
      {% set grid_import = states('sensor.grid_power_consumption') | float(0) %}
      {% set battery_discharge = states('sensor.battery_discharging_power') | float(0) %}

      {% set solar_to_home = home_consumption - grid_import - battery_discharge %}
      {{ (solar_to_home if solar_to_home > 0 else 0.0) | float(0) }}
  -
    # How much solar is charging the battery (not grid charging)
    # Battery charging - grid charging = solar charging
    name: "Solar Battery Charging"
    unique_id: "solar_battery_charging"
    icon: mdi:solar-power-variant
    unit_of_measurement: "W"
    device_class: power
    state_class: measurement
    state: >
      {% set battery_charging = states('sensor.battery_charging_power') | float(0) %}
      {% set battery_charge_from_grid = states('sensor.battery_charge_from_grid') | float(0) %}

      {% set solar_charging = battery_charging - battery_charge_from_grid %}
      {{ (solar_charging if solar_charging > 0 else 0.0) | float(0) }}
  -
    # The battery is charging when the sensor is negative
    name: "Battery Charging Power"
    unique_id: "battery_charging_power"
    unit_of_measurement: "W"
    device_class: power
    state_class: measurement
    state: >
      {% set battery_power = states('sensor.solplanet_al010k5sq2590170_power') | float(0) %}
      {% if battery_power < 0 %}
        {{ (battery_power * -1) | float(0) }}
      {% else %}
        {{ 0.0 | float(0) }}
      {% endif %}
  -
    # The battery is discharging when the sensor is positive
    name: "Battery Discharging Power"
    unique_id: "battery_discharging_power"
    unit_of_measurement: "W"
    device_class: power
    state_class: measurement
    state: >
      {% set battery_power = states('sensor.solplanet_al010k5sq2590170_power') | float(0) %}
      {% if battery_power > 0 %}
        {{ battery_power | float(0) }}
      {% else %}
        {{ 0.0 | float(0) }}
      {% endif %}
  -
    # Battery discharging to the grid:
    # Both grid export and battery discharge must be positive.
    # This is the portion of battery discharge that is going to grid,
    # up to the amount of grid export.
    name: "Battery Discharge to Grid"
    unique_id: "battery_discharge_to_grid"
    unit_of_measurement: "W"
    device_class: power
    state_class: measurement
    state: >
      {% set bat_discharge = states('sensor.battery_discharging_power') | float(0) %}
      {% set grid_export = states('sensor.grid_power_export') | float(0) %}
      {% if bat_discharge > 0 and grid_export > 0 %}
        {{ [bat_discharge, grid_export] | min | float(0) }}
      {% else %}
        {{ 0.0 | float(0) }}
      {% endif %}

  -
    # Portion of grid import that goes into charging the battery
    name: "Battery Charge from Grid"
    unique_id: "battery_charge_from_grid"
    unit_of_measurement: "W"
    device_class: power
    state_class: measurement
    state: >
      {% set bat_chg = states('sensor.solplanet_al010k5sq2590170_power') | float(0) %}
      {% set bat_chg = (-bat_chg if bat_chg < 0 else 0.0) | float(0) %}
      {% set meter_power = states('sensor.power_meter_active_power') | float(0) %}
      {% set grid_import = (-meter_power if meter_power < 0 else 0.0) | float(0) %}
      {% if bat_chg > 0 and grid_import > 0 %}
        {{ [bat_chg, grid_import] | min | float(0) }}
      {% else %}
        {{ 0.0 | float(0) }}
      {% endif %}

  -
    # Battery discharge that is NOT going to grid = discharge - discharge_to_grid
    name: "Battery Discharge Self Consumption"
    unique_id: "battery_discharge_self_consumption"
    unit_of_measurement: "W"
    device_class: power
    state_class: measurement
    state: >
      {% set bat_dis = states('sensor.solplanet_al010k5sq2590170_power') | float(0) %}
      {% set bat_dis = (bat_dis if bat_dis > 0 else 0.0) | float(0) %}
      {% set meter_power = states('sensor.power_meter_active_power') | float(0) %}
      {% set grid_export = (meter_power if meter_power > 0 else 0.0) | float(0) %}
      {% set bat_to_grid = (bat_dis > 0 and grid_export > 0) and [bat_dis, grid_export] | min or 0.0 %}
      {% set val = bat_dis - bat_to_grid %}
      {{ (val if val > 0 else 0.0) | float(0) }}

  # Create a sensor to know the current time of use pricing by Ausgrid NSW
  #
  # https://www.ausgrid.com.au/Your-energy-use/Meters/Time-of-use-pricing
  #
  # As of 1st of July 2024:
  # - Peak: 3pm-9pm, November to March (summer) and June to August (winter)
  # - Off-peak: All other times
  -
    name: TOU Period
    icon: mdi:clock-time-three-outline
    state: >
      {% set tou_period = 'offpeak' %}

      {% set n_month = now().month %}
      {% set n_hour = now().hour %}

      {% set is_summer = (n_month >= 11 or n_month <= 3) %}
      {% set is_winter = (6 <= n_month <= 8) %}

      {% if (is_summer or is_winter) and (15 <= n_hour < 21) %}
        {% set tou_period = 'peak' %}
      {% endif %}

      {{tou_period}}

  # Current electricity plan: Engie - NSW - Simply NRMA Solar 7/10% off
  -
    # Peak
    name: Electricity Peak Cost
    icon: mdi:currency-usd
    unit_of_measurement: AUD
    state: >
      {{ 0.6521900 * 0.93 }}
  -
    # Offpeak
    name: Electricity Offpeak Cost
    icon: mdi:currency-usd
    unit_of_measurement: AUD
    state: >
      {{ 0.3488100 * 0.93 }}
  -
    # Supply
    name: Electricity Supply Cost
    icon: mdi:currency-usd
    unit_of_measurement: AUD
    state: >
      {{ 1.8418400 * 0.93 }}
  -
    # A sensor to calculate the current cost of electricity based on the TOU and price
    name: Electricity Cost
    icon: mdi:currency-usd
    unit_of_measurement: AUD/kWh
    state: >
      {% if is_state('sensor.tou_period', 'peak') %}
        {{ states('sensor.electricity_peak_cost') }}
      {% elif is_state('sensor.tou_period', 'offpeak') %}
        {{ states('sensor.electricity_offpeak_cost') }}
      {% endif %}
  -
    # Feed in
    name: Solar Feed In
    icon: mdi:currency-usd
    unit_of_measurement: AUD/kWh
    state: "0.1200"

  # Alternative electricity plan: Red QANTAS Red Saver
  #
  # The price of the plan if there was no solar
  # We want to compare how much we would've paid if we didn't have Solar
  # This way we can calculate the difference in price/savings to come to a breakeven date
  -
    # Peak
    name: Alternative Electricity Peak Cost
    icon: mdi:currency-usd
    unit_of_measurement: AUD
    state: "0.48235"
  -
    # Offpeak
    name: Alternative Electricity Offpeak Cost
    icon: mdi:currency-usd
    unit_of_measurement: AUD
    state: "0.20878"
  -
    # Supply
    name: Alternative Electricity Supply Cost
    icon: mdi:currency-usd
    unit_of_measurement: AUD
    state: "0.87450"
  -
    # A sensor to calculate the alternative cost of electricity based on the TOU and price
    name: Alternative Electricity Cost
    icon: mdi:currency-usd
    unit_of_measurement: AUD/kWh
    state: >
      {% if is_state('sensor.tou_period', 'peak') %}
        {{ states('sensor.alternative_electricity_peak_cost') }}
      {% elif is_state('sensor.tou_period', 'offpeak') %}
        {{ states('sensor.alternative_electricity_offpeak_cost') }}
      {% endif %}

  # Electricity Usage TODAY
  # Add off-peak and peak periods together.
  -
    name: Electricity Usage Today - Solar
    state_class: total_increasing
    unit_of_measurement: kWh
    device_class: energy
    state: >
      {{
        states('sensor.solar_self_consumption_daily_offpeak') | float(0) +
        states('sensor.solar_self_consumption_daily_peak') | float(0)
      }}

  -
    name: Electricity Usage Today - Grid
    state_class: total_increasing
    unit_of_measurement: kWh
    device_class: energy
    state: >
      {{
        states('sensor.grid_power_import_daily_peak') | float(0) +
        states('sensor.grid_power_import_daily_offpeak') | float(0)
      }}

  -
    name: Electricity Usage Today - Total
    state_class: total_increasing
    unit_of_measurement: kWh
    device_class: energy
    state: >
      {{
        states('sensor.electricity_usage_today_solar') | float(0) +
        states('sensor.electricity_usage_today_grid') | float(0)
      }}

  # Electricity Usage YESTERDAY
  # Add off-peak and peak periods together.
  -
    name: Electricity Usage Yesterday - Solar
    state_class: total_increasing
    unit_of_measurement: kWh
    device_class: energy
    state: >
      {{
        state_attr('sensor.solar_self_consumption_daily_offpeak', 'last_period') | float(0) +
        state_attr('sensor.solar_self_consumption_daily_peak', 'last_period') | float(0)
      }}

  -
    name: Electricity Usage Yesterday - Grid
    state_class: total_increasing
    unit_of_measurement: kWh
    device_class: energy
    state: >
      {{
        state_attr('sensor.grid_power_import_daily_peak', 'last_period') | float(0) +
        state_attr('sensor.grid_power_import_daily_offpeak', 'last_period') | float(0)
      }}

  -
    name: Electricity Usage Yesterday - Total
    state_class: total_increasing
    unit_of_measurement: kWh
    device_class: energy
    state: >
      {{
        states('sensor.electricity_usage_yesterday_solar') | float(0) +
        states('sensor.electricity_usage_yesterday_grid') | float(0)
      }}

  # Electricity Usage MONTHLY
  # Add off-peak and peak periods together.
  -
    name: Electricity Usage Month - Solar
    state_class: total_increasing
    unit_of_measurement: kWh
    device_class: energy
    state: >
      {{
        states('sensor.solar_self_consumption_monthly_offpeak') | float(0) +
        states('sensor.solar_self_consumption_monthly_peak') | float(0)
      }}

  -
    name: Electricity Usage Month - Grid
    state_class: total_increasing
    unit_of_measurement: kWh
    device_class: energy
    state: >
      {{
        states('sensor.grid_power_import_monthly_peak') | float(0) +
        states('sensor.grid_power_import_monthly_offpeak') | float(0)
      }}

  -
    name: Electricity Usage Month - Total
    state_class: total_increasing
    unit_of_measurement: kWh
    device_class: energy
    state: >
      {{
        states('sensor.electricity_usage_month_solar') | float(0) +
        states('sensor.electricity_usage_month_grid') | float(0)
      }}


  # Calculate solar yield by adding the how much solar was exported + how much was self-consumed on a day/month basis
  -
    name: Solar Generated - Today
    state_class: total_increasing
    unit_of_measurement: kWh
    device_class: energy
    state: >
      {{
        states('sensor.grid_power_export_daily_anytime') | float(0) +
        states('sensor.electricity_usage_today_solar') | float(0)
      }}
  -
    name: Solar Generated - Yesterday
    state_class: total_increasing
    unit_of_measurement: kWh
    device_class: energy
    state: >
      {{
        state_attr('sensor.grid_power_export_daily_anytime', 'last_period') | float(0) +
        states('sensor.electricity_usage_yesterday_solar') | float(0)
      }}
  -
    name: Solar Generated - Month
    state_class: total_increasing
    unit_of_measurement: kWh
    device_class: energy
    state: >
      {{
        states('sensor.grid_power_export_monthly_anytime') | float(0) +
        states('sensor.electricity_usage_month_solar') | float(0)
      }}


  # Electricity costs DAILY
  # Calculated by multiplying how much was used/generated and multiplying by the price
  -
    name: Electricity Costs Today - Peak
    device_class: monetary
    state_class: total
    unit_of_measurement: AUD
    state: "{{ states('sensor.grid_power_import_daily_peak') | float(0)* states('sensor.electricity_peak_cost') | float(0) }}"
  -
    name: Electricity Costs Today - Offpeak
    device_class: monetary
    state_class: total
    unit_of_measurement: AUD
    state: "{{ states('sensor.grid_power_import_daily_offpeak') | float(0)* states('sensor.electricity_offpeak_cost') | float(0) }}"
  -
    name: Electricity Costs Today - Export
    device_class: monetary
    state_class: total
    unit_of_measurement: AUD
    state: "{{ states('sensor.grid_power_export_daily_anytime') | float(0)* states('sensor.solar_feed_in') | float(0) }}"
  -
    name: Electricity Costs Today - Import
    device_class: monetary
    state_class: total
    unit_of_measurement: AUD
    state: >
      {{
        states('sensor.electricity_supply_cost') | float(0) +
        states('sensor.electricity_costs_today_peak') | float(0) +
        states('sensor.electricity_costs_today_offpeak') | float(0)
      }}
  -
    name: Electricity Costs Today - Total
    device_class: monetary
    state_class: total
    unit_of_measurement: AUD
    state: >
      {{
        states('sensor.electricity_costs_today_import') | float(0) -
        states('sensor.electricity_costs_today_export') | float(0)
      }}

  # Electricity costs YESTERDAY
  # Calculated by multiplying how much was used/generated and multiplying by the price
  -
    name: Electricity Costs Yesterday - Peak
    device_class: monetary
    state_class: total
    unit_of_measurement: AUD
    state: "{{ state_attr('sensor.grid_power_import_daily_peak', 'last_period') | float(0)* states('sensor.electricity_peak_cost') | float(0) }}"
  -
    name: Electricity Costs Yesterday - Offpeak
    device_class: monetary
    state_class: total
    unit_of_measurement: AUD
    state: "{{ state_attr('sensor.grid_power_import_daily_offpeak', 'last_period') | float(0)* states('sensor.electricity_offpeak_cost') | float(0) }}"
  -
    name: Electricity Costs Yesterday - Export
    device_class: monetary
    state_class: total
    unit_of_measurement: AUD
    state: "{{ state_attr('sensor.grid_power_export_daily_anytime', 'last_period') | float(0)* states('sensor.solar_feed_in') | float(0) }}"
  -
    name: Electricity Costs Yesterday - Import
    device_class: monetary
    state_class: total
    unit_of_measurement: AUD
    state: >
      {{
        states('sensor.electricity_supply_cost') | float(0) +
        states('sensor.electricity_costs_yesterday_peak') | float(0) +
        states('sensor.electricity_costs_yesterday_offpeak') | float(0)
      }}
  -
    name: Electricity Costs Yesterday - Total
    device_class: monetary
    state_class: total
    unit_of_measurement: AUD
    state: >
      {{
        states('sensor.electricity_costs_yesterday_import') | float(0) -
        states('sensor.electricity_costs_yesterday_export') | float(0)
      }}

  # Electricity costs MONTHLY
  # Calculated by multiplying how much was used/generated and multiplying by the price
  -
    name: Electricity Costs Month - Peak
    device_class: monetary
    state_class: total
    unit_of_measurement: AUD
    state: "{{ states('sensor.grid_power_import_monthly_peak') | float(0)* states('sensor.electricity_peak_cost') | float(0) }}"
  -
    name: Electricity Costs Month - Offpeak
    device_class: monetary
    state_class: total
    unit_of_measurement: AUD
    state: "{{ states('sensor.grid_power_import_monthly_offpeak') | float(0)* states('sensor.electricity_offpeak_cost') | float(0) }}"
  -
    name: Electricity Costs Month - Export
    device_class: monetary
    state_class: total
    unit_of_measurement: AUD
    state: "{{ states('sensor.grid_power_export_monthly_anytime') | float(0)* states('sensor.solar_feed_in') | float(0) }}"
  -
    name: Electricity Costs Month - Supply
    device_class: monetary
    state_class: total
    unit_of_measurement: AUD
    state: "{{ (states('sensor.electricity_supply_cost') | float(0)) * (( now() | as_timestamp | int(0) - state_attr('sensor.grid_power_import_monthly_offpeak','last_reset') | as_timestamp | int(0)) / 86400 | int(0) ) }}"
  -
    name: Electricity Costs Month - Import
    device_class: monetary
    state_class: total
    unit_of_measurement: AUD
    state: >
      {{
        states('sensor.electricity_costs_month_supply') | float(0) +
        states('sensor.electricity_costs_month_peak') | float(0) +
        states('sensor.electricity_costs_month_offpeak') | float(0)
      }}
  -
    name: Electricity Costs Month - Total
    device_class: monetary
    state_class: total
    unit_of_measurement: AUD
    state: >
      {{
        states('sensor.electricity_costs_month_import') | float(0) -
        states('sensor.electricity_costs_month_export') | float(0)
      }}

  # How much we are paying for electricity this hour.
  # (daily supply cost / 24) + (current feed-in OR import * rate)
  -
    name: Electricity Costs Currently
    state_class: total
    unit_of_measurement: AUD
    device_class: monetary
    state: >
        {% set hourly = (states('sensor.electricity_supply_cost') | float(0)) / 24 %}
        {% set gridout = states('sensor.grid_power_export') | int(0) %}
        {% set gridin = states('sensor.grid_power_consumption') | int(0) %}
        {% if gridout > 0 %}
          {{ ((gridout/1000) * (states('sensor.solar_feed_in') | float(0) * -1) + hourly) | round(2) }}
        {% else %}
          {{ ((gridin/1000) * states('sensor.electricity_cost') | float(0) + hourly) | round(2) }}
        {% endif %}

  # How much we are paying for electricity per day, updated monthly using the utility meter integration
  # Divides the cost for the month by the amount of days
  -
    name: Electricity Costs Average Per Day
    state_class: total
    unit_of_measurement: AUD
    device_class: monetary
    state: >
      {{ (states('sensor.electricity_costs_month_total') | float(0) / ((now() | as_timestamp - state_attr('sensor.grid_power_import_monthly_offpeak','last_reset') | as_timestamp) / 86400)) | round(2) }}

  # Forecast how much the next bill be based on the daily average
  -
    name: Electricity Costs Bill Forecast
    state_class: total
    unit_of_measurement: AUD
    device_class: monetary
    state: >
      {{ (states('sensor.electricity_costs_average_per_day') | float(0)) * 28 }}

  # How much we would be paying if we were on the non-solar (alternative) plan for yesterday
  -
    name: Electricity Costs Alternative Plan
    state_class: total
    unit_of_measurement: AUD
    device_class: monetary
    state: >
      {{
        (
          (
            (states('sensor.alternative_electricity_offpeak_cost')|float(0)) * (
              (state_attr('sensor.solar_self_consumption_daily_offpeak', 'last_period')|float(0))
              +
              (state_attr('sensor.grid_power_import_daily_offpeak', 'last_period')|float(0))
            )
          )

          +

          (
            (states('sensor.alternative_electricity_peak_cost')|float(0)) * (
              (state_attr('sensor.solar_self_consumption_daily_peak', 'last_period')|float(0))
              +
              (state_attr('sensor.grid_power_import_daily_peak', 'last_period')|float(0))
            )
          )

          +

          (states('sensor.alternative_electricity_supply_cost')|float(0))
        ) | round(2)
      }}

  # Solar Initial Cost
  -
    name: Solar Initial Cost
    unit_of_measurement: AUD
    state: "13010"
    state_class: total
    device_class: monetary

  # Time until solar breakeven
  -
    # solar_days = How many days since installation
    # paid_off = initial cost minus input_number
    # average = paid_off / solar_days
    # remaining_days = input_number / average
    name: Solar Days Until Breakeven
    state_class: total
    state: >
      {% set solar_days = (as_timestamp(today_at()) - as_timestamp(states('input_datetime.solar_installation_date'))) / 86400 %}
      {% set paid_off = (states('sensor.solar_initial_cost')|float(0) - (states('input_number.solar_net_cost')|float(0) * -1)) %}
      {% set average = paid_off / solar_days %}
      {% set remaining_days = (states('input_number.solar_net_cost')|float(0) * -1) / average %}
      {{ remaining_days }}
  -
    # today + remaining_days
    name: Solar Breakeven Date
    state: >
      {% set days = states('sensor.solar_days_until_breakeven') | float(0) %}
      {% set nice_remaining_days = today_at() + timedelta(days=days) %}
      {{ nice_remaining_days.strftime('%d %b %Y') }}

  # Battery Usage TODAY
  # Add off-peak and peak periods together.
  -
    name: Battery Discharge Today
    state_class: total_increasing
    unit_of_measurement: kWh
    device_class: energy
    state: >
      {{
        states('sensor.battery_discharge_self_consumption_daily_offpeak') | float(0) +
        states('sensor.battery_discharge_self_consumption_daily_peak') | float(0)
      }}

  # Battery Usage YESTERDAY
  -
    name: Battery Discharge Yesterday
    state_class: total_increasing
    unit_of_measurement: kWh
    device_class: energy
    state: >
      {{
        state_attr('sensor.battery_discharge_self_consumption_daily_offpeak', 'last_period') | float(0) +
        state_attr('sensor.battery_discharge_self_consumption_daily_peak', 'last_period') | float(0)
      }}

  # Battery Usage MONTHLY
  -
    name: Battery Discharge Month
    state_class: total_increasing
    unit_of_measurement: kWh
    device_class: energy
    state: >
      {{
        states('sensor.battery_discharge_self_consumption_monthly_offpeak') | float(0) +
        states('sensor.battery_discharge_self_consumption_monthly_peak') | float(0)
      }}

  # Battery savings TODAY
  # Savings = discharge Ã— (import_rate - feed_in_rate)
  # Calculated per TOU period
  -
    name: Battery Savings Today - Peak
    device_class: monetary
    state_class: total
    unit_of_measurement: AUD
    state: >
      {{
        states('sensor.battery_discharge_self_consumption_daily_peak') | float(0) *
        (states('sensor.electricity_peak_cost') | float(0) - states('sensor.solar_feed_in') | float(0))
      }}
  -
    name: Battery Savings Today - Offpeak
    device_class: monetary
    state_class: total
    unit_of_measurement: AUD
    state: >
      {{
        states('sensor.battery_discharge_self_consumption_daily_offpeak') | float(0) *
        (states('sensor.electricity_offpeak_cost') | float(0) - states('sensor.solar_feed_in') | float(0))
      }}
  -
    name: Battery Savings Today - Total
    device_class: monetary
    state_class: total
    unit_of_measurement: AUD
    state: >
      {{
        states('sensor.battery_savings_today_peak') | float(0) +
        states('sensor.battery_savings_today_offpeak') | float(0)
      }}

  # Battery savings YESTERDAY
  -
    name: Battery Savings Yesterday - Peak
    device_class: monetary
    state_class: total
    unit_of_measurement: AUD
    state: >
      {{
        state_attr('sensor.battery_discharge_self_consumption_daily_peak', 'last_period') | float(0) *
        (states('sensor.electricity_peak_cost') | float(0) - states('sensor.solar_feed_in') | float(0))
      }}
  -
    name: Battery Savings Yesterday - Offpeak
    device_class: monetary
    state_class: total
    unit_of_measurement: AUD
    state: >
      {{
        state_attr('sensor.battery_discharge_self_consumption_daily_offpeak', 'last_period') | float(0) *
        (states('sensor.electricity_offpeak_cost') | float(0) - states('sensor.solar_feed_in') | float(0))
      }}
  -
    name: Battery Savings Yesterday - Total
    device_class: monetary
    state_class: total
    unit_of_measurement: AUD
    state: >
      {{
        states('sensor.battery_savings_yesterday_peak') | float(0) +
        states('sensor.battery_savings_yesterday_offpeak') | float(0)
      }}

  # Battery savings MONTHLY
  -
    name: Battery Savings Month - Peak
    device_class: monetary
    state_class: total
    unit_of_measurement: AUD
    state: >
      {{
        states('sensor.battery_discharge_self_consumption_monthly_peak') | float(0) *
        (states('sensor.electricity_peak_cost') | float(0) - states('sensor.solar_feed_in') | float(0))
      }}
  -
    name: Battery Savings Month - Offpeak
    device_class: monetary
    state_class: total
    unit_of_measurement: AUD
    state: >
      {{
        states('sensor.battery_discharge_self_consumption_monthly_offpeak') | float(0) *
        (states('sensor.electricity_offpeak_cost') | float(0) - states('sensor.solar_feed_in') | float(0))
      }}
  -
    name: Battery Savings Month - Total
    device_class: monetary
    state_class: total
    unit_of_measurement: AUD
    state: >
      {{
        states('sensor.battery_savings_month_peak') | float(0) +
        states('sensor.battery_savings_month_offpeak') | float(0)
      }}

  # Battery Initial Cost
  -
    name: Battery Initial Cost
    unit_of_measurement: AUD
    state: "6000"
    state_class: total
    device_class: monetary

  # Time until battery breakeven
  -
    name: Battery Days Until Breakeven
    state_class: total
    state: >
      {% set battery_days = (as_timestamp(today_at()) - as_timestamp(states('input_datetime.battery_installation_date'))) / 86400 %}
      {% set paid_off = (states('sensor.battery_initial_cost')|float(0) - (states('input_number.battery_net_cost')|float(0) * -1)) %}
      {% set average = paid_off / battery_days %}
      {% set remaining_days = (states('input_number.battery_net_cost')|float(0) * -1) / average %}
      {{ remaining_days }}
  -
    name: Battery Breakeven Date
    state: >
      {% set days = states('sensor.battery_days_until_breakeven') | float(0) %}
      {% set nice_remaining_days = today_at() + timedelta(days=days) %}
      {{ nice_remaining_days.strftime('%d %b %Y') }}

  # How much we are saving per day on average with the battery
  -
    name: Battery Savings Average Per Day
    state_class: total
    unit_of_measurement: AUD
    device_class: monetary
    state: >
      {% set battery_days = (as_timestamp(today_at()) - as_timestamp(states('input_datetime.battery_installation_date'))) / 86400 %}
      {% if battery_days > 0 %}
        {% set paid_off = (states('sensor.battery_initial_cost')|float(0) - (states('input_number.battery_net_cost')|float(0) * -1)) %}
        {{ (paid_off / battery_days) | round(2) }}
      {% else %}
        {{ 0.00 }}
      {% endif %}

{%- endraw %}

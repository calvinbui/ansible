---

- hosts: homeserver

  vars:
    application: tracearr

    container_network: "{{ networks.pub }}"

  tasks:
    - name: Create config folder
      ansible.builtin.file:
        path: "{{ config_directory }}"
        state: directory
        owner: "{{ common_user }}"
        group: "{{ common_root_group }}"
        mode: "0771"

    - name: Create postgres container
      ansible.builtin.include_role:
        name: postgres
      vars:
        postgres_image: docker.io/timescale/timescaledb-ha
        postgres_version: pg18.1-ts2.25.0
        postgres_password: !vault |
          $ANSIBLE_VAULT;1.1;AES256
          34326336646463633234323732366136353438326461626366343662636664383264633434663133
          6138363866343536386237636632323233333936376164640a383161366130666132666366646634
          31643866363537626235303532303337383061636230373836666339653436333632346238323733
          3232623135613638350a633433386136326534356433636635623833363762663561303732303461
          38333736393038613866303061643238666162633534376635653135613034626163626534643738
          6432353762636436633362303735323534306335633837643565

    - name: Create valkey container
      ansible.builtin.include_role:
        name: valkey
      vars:
        valkey_version: 9.0.3
        valkey_password: !vault |
          $ANSIBLE_VAULT;1.1;AES256
          62623762393336623461343839626431323462333430616163623432653561613365303565643963
          6163363362376334303837376332663937336434373434380a643936386466623931613965303834
          39336331623930666131653331656466353163373536616564666166613066343139666662313032
          3066323530616230620a336535653731643764376438623630663835323637323864326339393438
          31323838356535353966653762633862623634353166396465623933326638653862333937373664
          3137633166646639633261343662643632643038323434323931

    - name: Create container
      ansible.builtin.include_role:
        name: podman_container
      vars:
        image: ghcr.io/connorgallopo/tracearr:1.4.19
        env:
          NODE_ENV: production

          DATABASE_URL: "{{ _postgres_url }}"

          REDIS_URL: "{{ _valkey_url }}"

          JWT_SECRET: !vault |
            $ANSIBLE_VAULT;1.1;AES256
            30323434363834343965646538316436323835343930656231633165303537373637396434626565
            6230303532386361346331663462323633633137623830660a666532303035386663636332623034
            38616165373037666163376139333535643961626562323865356230663439363261313466616166
            6432623334323139350a633862363137336533643434353335333463366636313464376661663131
            34316564633333393431346666366331656133326363366337343836396466636133633861393930
            30376230653131376635356336666561363339393136653237393631326331376534333064356533
            31343862343165373135636431393466613265643961376662386366323733353966383761393862
            30316138626666613664
          COOKIE_SECRET: !vault |
            $ANSIBLE_VAULT;1.1;AES256
            30306232643137613565303432663739626664633765356333383639656430613139623566366666
            6163303032376538313835646264623031643866346362620a336662383665363139306436303137
            66363663633132383733646236663063323737653535623233303339313133316132353564643265
            3536313062386234310a636132343563616266616364346565353230653137663564353031386462
            38633733353438303736653731393564313336303737653138363132633436373434356261633138
            38626135643366343335363332666638356338363132333862333666306633316136353232336331
            61346630313436336131336538323436633635613966346331623630336136376265383735663239
            34316430663063376531
          CORS_ORIGIN: "*"
          LOG_LEVEL: info

          TZ: "{{ common_timezone }}"
        traefik:
          - port: 3000
        homepage:
          group: Plex
          weight: 680
          description: "Real-time monitoring for Plex"
        blackbox:
          path: /health

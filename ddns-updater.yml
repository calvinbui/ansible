---

- hosts: homeserver

  vars:
    application: ddns-updater

    ddns_updater_domains:
      # main domain
      -
        provider: cloudflare
        zone_identifier: !vault |
          $ANSIBLE_VAULT;1.1;AES256
          39323137353330383061396234616362303534616633653534643039396132663935323634303861
          3234316264666233356631373038373066346230626435630a313436386130653864353564326339
          33393332633262363138316263323630363239643564636539396535633736623935313861356161
          3938393364623136350a346639383561653234323163333031343234643037623634316135636630
          37336263663131303361663935363131373632656431616661343862303637323534333135653638
          3933613438643734303438623030613035623033656439663862
        domain: !vault |
          $ANSIBLE_VAULT;1.1;AES256
          66313936626433663966343366323233666637653839383664626262373465376235383539326165
          6662626163626364336238376161313633343861353264630a306431356235376635386133623163
          62383030336265333565616665623665643839666365656630666430306263366132316234623864
          3338313637363632370a633431386666316530633534623961306266366163633634656265323761
          3031
        ttl: 1
        token: !vault |
          $ANSIBLE_VAULT;1.1;AES256
          62656162346237373436366432313736346361323062656365633339383435376230396338623439
          6561663239386131336430366231623334636631346431650a333866383830313333333065643635
          64323635336332393437623335306332326661326566386134343039386632346232363864376534
          3138663130646530610a306332616133366662343331613937626265353064646364323637383434
          35313938393565343063356265663839373162373561633133656432333530363833393137626530
          3162323536323963663336366439653266303938626537633739

      # main domain wildcard
      -
        provider: cloudflare
        zone_identifier: !vault |
          $ANSIBLE_VAULT;1.1;AES256
          35653731303962303562373466393131323963636438336338363064646130356236303063623837
          6262386334363937343838633237646639623439343334650a303565393838663532653635366165
          63343730356263393534643566323663656636636431626537353833366565633663383565366362
          3133326139633839390a333733386337613235383330643832663963336339636530356262656333
          31363537616330303230643463623262613664333462323564306230393936653239346236616531
          3436366632313532303335663837613431643236646631623766
        domain: !vault |
          $ANSIBLE_VAULT;1.1;AES256
          66613535313336666164353565613732666236656639626536333235333263626338313336336336
          3965336633353262636466313031333965636436336361620a636531326663646438383864333966
          30613865313065656531646363323536396464326438376638373832633235383064343832346166
          6335343962363361310a343764396530373561363161323636396339333063386166313235363835
          3661
        ttl: 1
        token: !vault |
          $ANSIBLE_VAULT;1.1;AES256
          66626366373731653533666662613263326538663437613338383737643965326361333936343933
          6563356430346665313539386431306664366535306239330a656464653332363934646139626162
          36656235346463623839616137363537326466316230383033666563623330316430336636383033
          3564373732306562340a616262633230623863613938366261636235303936663962623662303132
          32366639323639623331623131623865393066633337323762636561626565393033313361386334
          6531333564643431373837656666313438316135396634306635

    # website umami
      -
        provider: cloudflare
        zone_identifier: !vault |
          $ANSIBLE_VAULT;1.1;AES256
          39363736633662303562336632306632353361363338346237333239613231326633346133373738
          6336376635616432613863326335333365393865663334370a303636363764313837336232386437
          33363530646431646234303938323730303538353030623635643738623533346562653535643834
          6264643466333562380a343639333236373866656164343762393862346637633363316461303261
          33333334316436353661373437643866363463343833343438626337363638656431663561303064
          3562623135336534356230363838613966343330373831373464
        ttl: 1
        domain: !vault |
          $ANSIBLE_VAULT;1.1;AES256
          36306536616462663830326566386238376139353434376537626564613236643838343038313330
          3161393239633333633264333733363038336364626263300a323966336231383730343432643863
          63303234623830326161323563326132633632643466346464326533383662666433636532323435
          6235326630626361350a303561663364323766336233383931303431346461316639343033313638
          6239
        token: !vault |
          $ANSIBLE_VAULT;1.1;AES256
          64353130353636656337353138336232613631626264336635363734363332613335333739643866
          6162333563663561306534666537623366306639366662330a313962323630616361323233363939
          31626566666662303536646465383730373036373230306138613062306138623335366135666465
          3230343237633165370a356131346432643133376338363938616162656237396133633737353861
          30373634306137616636386161336161653934323239316237663565313430336662343462396365
          3731323761306233613736383138376235613762396266663438

      # website umami short
      -
        provider: cloudflare
        zone_identifier: !vault |
          $ANSIBLE_VAULT;1.1;AES256
          38383633646361616337376337333732656363323333376538303733323162316534613237613464
          3964376364653631646432613464313538636166633162650a393438656332653237643330643566
          34343865366261393164356364336561393230316363303331363139353562386463326461616664
          3831373635613865370a666563656662316363396165366266636337323262656162353438393864
          38303334626538656636316363313164306661663437356136383837376561313033643435666333
          3131643338376466393037353061353139623163636135343839
        ttl: 1
        domain: !vault |
          $ANSIBLE_VAULT;1.1;AES256
          39303833663038643935626636373261356330386263643134643332633138303065376333333265
          6139356263356361373337643332666263303463393762390a356663656562616461363164613939
          63376461323762356439346463666633313638343565613430646663383730386135373634333630
          6234363366336336630a323638353134383265343536313665323734333838626330333763343830
          6537
        token: !vault |
          $ANSIBLE_VAULT;1.1;AES256
          65636238396433306434343133356466326264636234656265623962643738306132663835396437
          6437663665383562613331343035653962396638326562310a376235656432626439343538616133
          61646138343739303836316261386361623961303933626438623039623466383538656561386430
          6233653765373966650a323130343133363535376239373462633137656431636134316436376133
          32303862613730393031393336653261663862386134666330313537643964396639393365376337
          3535316265633033666433356436323365656234626636346539

    container_network: "{{ networks.guest }}"

  handlers:
    - name: Restart
      containers.podman.podman_container:
        name: "{{ application }}"
        force_restart: true

  tasks:
    - name: Create config folder
      ansible.builtin.file:
        path: "{{ config_directory }}"
        state: directory
        owner: "{{ common_user }}"
        group: "{{ common_group }}"
        mode: "0771"

    - name: Create config
      ansible.builtin.template:
        src: "{{ files_directory }}/config.json.j2"
        dest: "{{ config_directory }}/config.json"
        owner: "{{ common_user }}"
        group: "{{ common_group }}"
        mode: "0740"
      notify: Restart

    - name: Create container
      ansible.builtin.include_role:
        name: podman_container
      vars:
        image: ghcr.io/qdm12/ddns-updater:2.9.0
        volumes:
          - "{{ config_directory }}:/updater/data"
        traefik:
          - port: 8000
            auth: page
        homepage:
          name: ddns-updater
          group: Networking
          weight: 500
          description: Lightweight universal DDNS updater program
